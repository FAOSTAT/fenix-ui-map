<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel='icon' type='image/png' href='http://fenixapps.fao.org/repository/favicon/faostat.png'>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>

    <link rel='icon' type='image/png' href='http://fenixapps.fao.org/repository/favicon/faostat.png'>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Fenix - Maps</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/css/bootstrap.min.css">

    <!--Fenix Map -->
    <!-- leaflet -->
    <link rel="stylesheet" href="http://fenixapps.fao.org/repository/js/leaflet/0.7.2/leaflet.css" />

    <link rel="stylesheet" href="http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.markecluster/1.0/MarkerCluster.Default.css" />

    <!-- choosen css -->
    <link href='http://fenixapps.fao.org/repository/js/chosen/1.0.0/chosen.min.css' rel='stylesheet'>

    <!-- Fenix Map CSS -->
    <link rel="stylesheet" href="../../css/fenix-map-js.css" />
    <link rel="stylesheet" href="../../css/leaflet-custom.css" />

    <!-- fenix-map-js -->
    <script type='text/javascript' src='../../js/fenix-map-js-min-all.js'></script>
    <script type='text/javascript' src='../../js/fenix-map-js-config.js'></script>

    <!-- dependencies -->
    <script src='http://fenixapps.fao.org/repository/js/FENIX/utils/import-dependencies-1.0.js'></script>

    <link rel="stylesheet" href="http://fenixapps.fao.org/repository/js/jquery-ui/1.10.3/jquery-ui-1.10.3.custom.min.css" />
    <link rel="stylesheet" href="http://fenixapps.fao.org/repository/css/jquery.power.tip/1.1.0/jquery.powertip.css" type="text/css" />

    <script type='text/javascript' src="http://fenixapps.fao.org/repository/js/jquery.power.tip/1.1.0/jquery.powertip.min.js"></script>

    <script type='text/javascript' src='http://fenixapps.fao.org/repository/js/jquery.hoverIntent/1.0/jquery.hoverIntent.js'></script>

    <!-- JSON Handler Old IE -->
    <script type='text/javascript' src='http://fenixapps.fao.org/repository/js/json2/1.0/json2.js'></script>

    <!-- Highchart -->
    <script src="http://fenixapps.fao.org/repository/js/highcharts/3.0.7/js/highcharts.js"></script>
    <script src="http://fenixapps.fao.org/repository/js/highcharts/3.0.7/js/modules/exporting.js"></script>

    <!--bootstrap-->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>

    <!-- CSV reader -->
    <script src="http://fenixapps.fao.org/repository/js/csvjson/1.0/csvjson.min.1.0.js"></script>

    <!-- choosen JS -->
    <script type='text/javascript' src='http://fenixapps.fao.org/repository/js/chosen/1.0.0/chosen.jquery.min.js'></script>

    <!-- Drawing plugin -->
    <link rel="stylesheet" href="http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/0.2.3/leaflet.draw.css" />
    <script type='text/javascript' src="http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/0.2.3/leaflet.draw.js"></script>

    <script type='text/javascript' src='http://fenixapps.fao.org/repository/js/FENIX/fenix-map-js/2.1/wkt.js'></script>

    <!-- sync -->
    <script type='text/javascript' src="http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.sync/1.0/L.Map.Sync.js"></script>


    <!-- scatter chart -->
    <script src="http://fenixapps.fao.org/repository/js/FENIX/fenix-map-js/2.1/js/plugins/ChartLibrary.js"></script>
    <script src="http://fenixapps.fao.org/repository/js/highcharts/plugins/regression/1.0/regression.js"></script>

    <script src="../../js/map/controller/SpatialQuery.js"></script>


    <!-- WKT Parser -->
    <script type='text/javascript' src="http://fenixapps.fao.org/repository/js/leaflet/terraformer/1.0.2/terraformer-1.0.2.min.js"></script>
    <script type='text/javascript' src="http://fenixapps.fao.org/repository/js/leaflet/terraformer/wkt-parser/1.0/terraformer-wkt-parser.min.js"></script>

    <!-- scatter chart -->
    <script src="../../js/plugins/ChartLibrary.js"></script>
    <script src="../../js/plugins/FMChartScatterRefactoring.js"></script>
    <script src="http://fenixapps.fao.org/repository/js/highcharts/plugins/regression/1.0/regression.js"></script>



    <script src="../../js/map/controller/SpatialQuery.js"></script>
    <script src="../../js/map/controller/MapControllerDraggable.js"></script>
    <script src="../../js/map/Map.js"></script>
    <script src="./../js/map/layer/Layer.js"></script>

</head>

<body onload="initialize();">

<div class='container'>
    <div class="page-header">
        <h3>
            <p class="text-primary">Near East - EVI/Precipitation Analysis</p>
        </h3>
    </div>

    <div style='height: 15px;'></div>

    <div id="container-charts"></div>

    <div style='height: 25px;'></div>
    <div id="output"></div>
</div>

</body>

</html>

<script>

var charts =  new Array();
var maps =  new Array()
var slaveCharts = new Array();
var slaveMaps = new Array();
var files = [
    {
        url: 'csv/gaul2/NearEast_prec2_EVI20140202_scatter.csv',
        title: 'Precipitation'
    }
   /* ,{
        url: 'csv/GAUL1_NGA_rainfall_2005-2006.csv',
        title: 'Title2'
    },
    {
        url: 'csv/GAUL1_NGA_rainfall_2005-2006.csv',
        title: 'Title3'
    }*/
]

function initialize() {
    loadGUI();
    /*FM.init( function() {
     loadGUI();
     } );*/
}

function loadGUI() {
    var id = _generateRandomID()
    var chartID = 'chart-' + id;
    var mapID = 'map-' + id;
    _createGUI(chartID, mapID);
    files[0].mapID = mapID;
    files[0].chartID = chartID;
    $.get(files[0].url, files[0]).done(function( data ) {
        createScatter(data, getJsonFromUrl(this.url));
        for(var i=1; i < files.length; i++)
            loadFile(files[i].url, files[i]);
    });
}

function loadFile(url, obj) {
    var id = _generateRandomID()
    var chartID = 'chart-' + id;
    var mapID = 'map-' + id;
    _createGUI(chartID, mapID);
    obj.mapID = mapID;
    obj.chartID = chartID;
    $.get(url, obj).done(function( data ) {
        createScatter(data, getJsonFromUrl(this.url));
    });
}

function _generateRandomID() {
    var randLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
    return randLetter + Date.now();
}
function _createGUI(chartID, mapID) {
    var ui =
            '<div class="row">' +
                    '<div class="col-lg-6">' +
                    '<div id="'+ chartID +'" ></div>'+
                    '</div>' +
                    '<div class="col-lg-6"> '+
                    '<div id='+ mapID +' class="fm-box" style="overflow: hidden; margin: 0 auto; text-align: left;height: 400px;"></div>'+
                    '<div id='+ mapID +'-gfioutput></div>' +

                    '</div>' +
                    '</div>';

    ui += '<div style="height:25px;"></div>'
    $('#container-charts').append(ui);
}

function createScatter(csv, obj) {

    var c = new FMChartScatter();


    var chartID = obj.chartID;
    var mapID = obj.mapID;

    // TODO: just use a master chart
    if ( charts.length < 1  )
        charts.push(c);
    else {
        slaveCharts.push(c)
        var masterChart = charts[0];
        masterChart.linkSlaveCharts(slaveCharts);
    }

    /*var fenixMap = createMap(mapID);
     maps.push(fenixMap);

     var l = createLayer();
     var layerHighlight = createHighlightLayer(fenixMap);
     var layerHover = createLayerHover(fenixMap);*/


    // to handle multiple maps
    var mapsArray = [];

    // single map
    var map = {};
    // to handle multiple layers

    var fenixMap = createMap(mapID);
    var l = createLayer();
    var layerHighlight = createHighlightLayer(fenixMap);

    map.id = mapID;
    map.fenixMap = fenixMap;
    map.layers = [];
    map.layers.push({ l: l });
    mapsArray.push(map);
    maps.push(fenixMap);

    c.init({
        chart : { data : csv, id : chartID, datatype: 'csv',  chart_title: obj.title },
        maps: mapsArray
    });

    // On Move
    /* var _m = fenixMap;
     var GFIchk = {};
     GFIchk["lat-" + fenixMap.id] = 0;
     GFIchk["lng-" + fenixMap.id] = 0;
     GFIchk["globalID-" + fenixMap.id] = 0;
     fenixMap.map.on('mousemove', function (e) {
     var id = Date.now();
     GFIchk["globalID-" + _m.id] = id;
     var t = setTimeout(function() {
     if ( id == GFIchk["globalID-" + _m.id]) {
     if ((GFIchk["lat-" + _m.id] != e.latlng.lat) && (GFIchk["lng-" + _m.id] != e.latlng.lng)) {
     GFIchk["lat-" + _m.id] = e.latlng.lat;
     GFIchk["lng-" + _m.id] = e.latlng.lng;
     // call callback
     _m.getFeatureInfo(e, mapID +'-gfioutput');
     //_m.getFeatureInfo(e);

     }
     }
     }, 100);
     });
     fenixMap.map.on('mouseout', function (e) {
     GFIchk["lat-" + _m.id] = 0;
     GFIchk["lng-" + _m.id] = 0;
     GFIchk["globalID-" + _m.id] = 0;
     $('#' + mapID +'-gfioutput').empty();
     });*/

    maps[0].syncOnMove(fenixMap);
}

function createMap(mapID) {
    var options = {
        plugins: {
            geosearch : false,
            mouseposition: false,
            controlloading : true,
            zoomControl: 'bottomright'
        },
        guiController: {
            overlay : true,
            baselayer: true,
            wmsLoader: true
        },
        gui: {
            disclaimerfao: true
        }
    }

    var mapOptions = {
        zoomControl:false,
        attributionControl: false
    };

    var m = new FM.Map(mapID, options, mapOptions);
    m.createMap();
    //m.zoomTo('GAUL0', '182')

    var tile = createBaseLayer('ESRI_WORLDSTREETMAP','EN' );
    m.addTileLayer(tile, true);

    return m;
}

function createLayer() {
    var layer = {};
    layer.layers='gaul2_3857'
    layer.styles=''
    layer.layertitle="Scatter Analysis"
    layer.joincolumn='adm2_code'
    layer.joindata=''
    //layer.addborders='true'
    //layer.borderscolor='FFFFFF'
    //layer.bordersstroke='0.8'
    //layer.bordersopacity='0.4'
    layer.legendtitle='Value X/Value Y'
    //layer.cql_filter="adm0_code IN (182)";
    layer.mu = 'Index';
    layer.srs = 'EPSG:3857';
    layer.layertype = 'JOIN';
    layer.lang='e';
    layer.jointype='shaded';
    layer.defaultgfi = true;
    layer.openlegend = true;
    layer.geometrycolumn = 'the_geom'
    /*layer.intervals='3';
    layer.colors='965a00,e88a00,f3ab2d';*/
    layer.intervals='5';
    layer.colors='8b001d,965a00,e88a00,f3ab2d,eb3660';
    //layer.colors='8b001d,d5002b,eb3660';

    //layer.colors='680000,D80000,FFFF00,00CC33,009900';
    //layer.colors='FF0AFF,FF1EFF,D700D7,CD00CD';


    // layer.formula = 'series[i].data[j].x / series[i].data[j].y';
    //layer.formula = '';
    //layer.formula = '(series[i].data[j].x / series[i].data[j].y) * 100';
    layer.reclassify = false;

    var l = new FM.layer(layer);
    return l
}

function createHighlightLayer(m) {
    var layer = {};
    layer.urlWMS = 'http://fenixapps.fao.org/geoserver'
    layer.layers='gaul2_3857'
    layer.styles=''
    layer.layertitle="Scatter Analysis (Highlight)"
    layer.joincolumn='adm2_code'
    layer.style = 'highlight_features';
    layer.srs = 'EPSG:3857';
    layer.opacity='0.9';
    // layer.hideLayerInControllerList = true; // this to hide the layer from the controller list
    layer.cql_filter="";
    var layerHighlight = new FM.layer(layer, m);
    layerHighlight.zindex = 104
    //m.addLayerWMS(layerHighlight)
    return layerHighlight;
}

function createLayerHover(m) {
    var layer = {};
    layer.urlWMS = 'http://fenixapps.fao.org/geoserver'
    layer.layers='gaul2_3857'
    layer.styles=''
    layer.layertitle="GAUL2 (hover)"
    layer.joincolumn='adm2_code'
    layer.style = 'highlight_features';
    layer.srs = 'EPSG:3857';
    layer.opacity='0.9';
    //layer.enabled= false;
    layer.cql_filter="";
    var l = new FM.layer(layer, m);
    l.zindex = 106
    return l;
}

function createBaseLayer(layername, lang) {
    var layer = {};
    layer.layername =layername;
    layer.layertype ='TILE';
    layer.lang = lang;
    var l = new FM.TileLayer(layer);
    l.leafletLayer = l.createTileLayer(layer.layername);
    return l;
}

function getJsonFromUrl(url) {
    // log(location.search);
    var query = url.split('?');
    var data = query[1].split("&");
    var result = {};
    for(var i=0; i<data.length; i++) {
        var item = data[i].split("=");
        result[decodeURI(item[0].replace(/\+/g, '%20'))] = decodeURI(item[1].replace(/\+/g, '%20'));
    }
    return result;
}

</script>