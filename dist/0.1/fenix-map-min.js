var FM,originalFM;"undefined"!==typeof exports?FM=exports:(originalL=window.FM,FM={noConflict:function(){window.FM=originalFM;return this}},window.FM=FM);FM.version="0.0.1";FM.author="Simone Murzilli - simone.murzilli@gmail.com; simone.murzilli@fao.org";FM.Class=function(){};
FM.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments);this._initHooks&&this.callInitHooks()},c=function(){};c.prototype=this.prototype;var d=new c;d.constructor=b;b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);a.statics&&(FM.extend(b,a.statics),delete a.statics);a.includes&&(FM.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes);a.options&&d.options&&(a.options=FM.extend({},d.options,a.options));FM.extend(d,
a);d._initHooks=[];var f=this;d.callInitHooks=function(){if(!this._initHooksCalled){f.prototype.callInitHooks&&f.prototype.callInitHooks.call(this);this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;a<b;a++)d._initHooks[a].call(this)}};return b};FM.Class.include=function(a){FM.extend(this.prototype,a)};FM.Class.mergeOptions=function(a){FM.extend(this.prototype.options,a)};
FM.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1);this.prototype._initHooks=this.prototype._initHooks||[];this.prototype._initHooks.push("function"===typeof a?a:function(){this[a].apply(this,b)})};FM.Util={loadedModules:[],dependencies:null,initializeLangProperties:function(a){var b="";switch(a){case "FR":b="fr";break;case "ES":b="es";break;default:b="en"}$.i18n.properties({name:"I18N",path:FMCONFIG.BASEURL+"/"+FMCONFIG.BASEURL_LANG,mode:"both",language:b})},extend:function(a){var b=Array.prototype.slice.call(arguments,1),c,d,e,f;d=0;for(e=b.length;d<e;d++)for(c in f=b[d]||{},f)f.hasOwnProperty(c)&&(a[c]=f[c]);return a},bind:function(a,b){var c=2<arguments.length?Array.prototype.slice.call(arguments,
2):null;return function(){return a.apply(b,c||arguments)}},stamp:function(){var a=0;return function(b){b._leaflet_id=b._leaflet_id||++a;return b._leaflet_id}}(),limitExecByInterval:function(a,b,c){var d,e;return function g(){var k=arguments;d?e=!0:(d=!0,setTimeout(function(){d=!1;e&&(g.apply(c,k),e=!1)},b),a.apply(c,k))}},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},splitWords:function(a){return a.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(a,
b){a.options=L.extend({},a.options,b);return a.options},getParamString:function(a,b){var c=[],d;for(d in a)a.hasOwnProperty(d)&&c.push(d+"="+a[d]);return(b&&-1!==b.indexOf("?")?"&":"?")+c.join("&")},template:function(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,d){var e=b[d];if(!b.hasOwnProperty(d))throw Error("No value provided for variable "+a);return e})},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="};
(function(){function a(a){var b,c,d=["webkit","moz","o","ms"];for(b=0;b<d.length&&!c;b++)c=window[d[b]+a];return c}function b(a){var b=+new Date,d=Math.max(0,16-(b-c));c=b+d;return window.setTimeout(a,d)}var c=0,d=window.requestAnimationFrame||a("RequestAnimationFrame")||b,e=window.cancelAnimationFrame||a("CancelAnimationFrame")||a("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};FM.Util.requestAnimFrame=function(a,c,e,h){a=L.bind(a,c);if(e&&d===b)a();else return d.call(window,
a,h)};FM.Util.cancelAnimFrame=function(a){a&&e.call(window,a)};FM.Util.replaceAll=function(a,b,c){return a.replace(RegExp(b,"g"),c)};FM.Util.parseLayerRequest=function(a){a=eval(a);var b="";$.each(a,function(a,c){b+="&"+a+"="+c});return b};FM.Util.loadModuleLibs=function(a,b){FM.Util.isModuleLoaded(a)||(null==FM.Util.dependencies?FM.DEPENDENCIES[a]?FM.Util.loadDependencies(a,b):b():FM.Util.loadDependencies(a,b))};FM.Util.loadDependencies=function(a,b){var c=FM.DEPENDENCIES[a];"string"==typeof c&&
(c=$.parseJSON(c));if(c){var d=[];if(null!=c.css)for(var e=0;e<c.css.length;e++)d.push(c.css[e]);if(null!=c.js)for(e=0;e<c.js.length;e++)d.push(c.js[e]);ImportDependencies.importSequentially(d,b)}};FM.Util.isModuleLoaded=function(a){for(var b=0;b<FM.Util.loadedModules.length;b++)if(FM.Util.loadedModules[b]==a)return!0;return!1};FM.Util.randomID=function(){return(Math.random().toString(36).substring(7)+Date.now()).toLocaleLowerCase()};FM.Util.fire=function(a,b,c){var d=document.createEvent("CustomEvent");
d.initCustomEvent(b,!0,!0,c);a.dispatchEvent(d)};FM.Util.on=function(a,b,c,d){a.addEventListener(b,d,!1)}})();FM.extend=FM.Util.extend;FM.bind=FM.Util.bind;FM.stamp=FM.Util.stamp;FM.setOptions=FM.Util.setOptions;FM.replaceAll=FM.Util.replaceAll;FM.loadModuleLibs=FM.Util.loadModuleLibs;FM.initializeLangProperties=FM.Util.initializeLangProperties;(function(a){function b(){this.clear()}b.prototype={constructor:b,get:function(a){return(a=this._data[this.hash(a)])&&a[1]},set:function(a,b){this._data[this.hash(a)]=[a,b]},has:function(a){return this.hash(a)in this._data},remove:function(a){delete this._data[this.hash(a)]},type:function(a){var b=Object.prototype.toString.call(a).slice(8,-1).toLowerCase();return"domwindow"!==b||a?b:a+""},count:function(){var a=0,b;for(b in this._data)a++;return a},clear:function(){this._data={}},hash:function(a){switch(this.type(a)){case "undefined":case "null":case "boolean":case "number":case "regexp":return a+
"";case "date":return":"+a.getTime();case "string":return'"'+a;case "array":for(var d=[],e=0;e<a.length;e++)d[e]=this.hash(a[e]);return"["+d.join("|");default:return a._hmuid_||(a._hmuid_=++b.uid,Object.defineProperty&&Object.defineProperty(a,"_hmuid_",{enumerable:!1})),"{"+a._hmuid_}},forEach:function(a){for(var b in this._data){var e=this._data[b];a(e[1],e[0])}}};b.uid=0;a.HashMap=b})(this.exports||this);var RequestHandler=function(){return{request:null,timeout:1E4,init:function(){"undefined"!=typeof XDomainRequest?(this.request=new XDomainRequest,this.setTimeout(this.timeout)):this.request=new XMLHttpRequest},open:function(a,b,c){this.request||this.init();"undefined"==typeof XDomainRequest?null!=c?this.request.open(a,b,c):this.request.open(a,b,!0):this.request.open(a,b)},setTimeout:function(a){this.request||this.init();"undefined"!=typeof XDomainRequest&&(this.timeout=1E4)},setContentType:function(a){this.request||
this.init();try{this.request.contentType=a}catch(b){}"undefined"==typeof XDomainRequest&&this.request.setRequestHeader("Content-Type",a)},onload:function(a){this.request||this.init();this.request.onload=a},send:function(a){this.request||this.init();this.request.send(a)}}};FM.UIUtils={fullscreen:function(a,b){var c=document.getElementById(b);if(window.fullScreenApi.supportsFullScreen)$("#"+a).on("click",function(){window.fullScreenApi.requestFullScreen(c)})},loadingPanel:function(a,b){var c="25px";b&&(c=b);document.getElementById(a).innerHTML="<div class='fm-loadingPanel' style='height:"+c+"'><img src='"+FMCONFIG.BASEURL+"/images/loading.gif'></div>"}};$.fn.swapWith=function(a){return this.each(function(){var b=$(a).clone(),c=$(this).clone();$(a).replaceWith(c);$(this).replaceWith(b)})};FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(a,b,c,d,e){this._divID=a;this._dropdowndID=a+"-dropdown";this._outputID=b;this._fenixmap=c;this._wmsServers=d;e&&(this._lang=e);this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,c)},_createWMSDropDown:function(a,b,c,d,e){for(var f='<select id="'+c+'" style="width:200px" data-placeholder="'+$.i18n.prop("_selectaWMSServer")+
'" class="">',f=f+'<option value=""></option>',g=0;g<a.length;g++)f+='<option value="'+a[g].url+'">'+a[g].label+"</option>";f+="</select>";$("#"+b).empty();$("#"+b).append(f);try{$("#"+c).chosen({disable_search_threshold:10,width:"100%"})}catch(k){}var h=this;$("#"+c).change({},function(a){h._createWMSOutputRequest(d,e,$(this).val(),null)})},_createWMSOutputRequest:function(a,b,c,d){$("#"+a).empty();FM.UIUtils.loadingPanel(a,"30px");var e="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES,
e=e+"?SERVICE=WMS&VERSION=1.1.1",e=e+"&request=GetCapabilities",e=e+("&urlWMS="+c);d&&(e+="&="+d);var f=this;d=new XMLHttpRequest;d.open("GET",e,!0);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onload=function(){var d=$.parseXML(this.responseText);f._createWMSOutput(a,b,d,c)};d.send()},_createWMSOutput:function(a,b,c,d){$("#"+a).empty();$(c).find("Layer").each(function(){if($(this).children("Name").text()&&""!=$(this).children("Name").text()){var c=FM.Util.randomID(),f=
FM.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",c);$("#"+a).append(f);$("#"+c+"-WMSLayer-title").append($(this).children("Title").text());$("#"+c+"-WMSLayer-title").attr("title",$(this).children("Title").text());try{$("#"+c+"-WMSLayer-title").powerTip({placement:"n"})}catch(g){}f={};f.layers=$(this).children("Name").text();f.layername=$(this).children("Name").text();f.layertitle=$(this).children("Title").text();f.style=$(this).children("Style").children("Name").text();f.urlWMS=d;f.srs=b.map.options.crs.code;
f.openlegend=!0;console.log($(this));$("#"+c+"-WMSLayer-box").click({fenixmap:b,layer:f},function(a){a.data.layer.openlegend=!1;var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayer(b);FMPopUp.init({parentID:a.data.fenixmap.id,content:"The Layer <b>"+a.data.layer.layertitle+"</b><br> has been added to the map"})});var f=$.extend(!0,{},f),k=new FM.layer(f,b);try{$("#"+c+"-WMSLayer-box").hoverIntent({over:function(){k.addLayer()},out:function(){k.removeLayer()},timeout:500})}catch(h){}}})},addWMSServer:function(){},
_WMSCapabilities:function(a,b,c,d){var e="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES,e=e+"?SERVICE=WMS&VERSION=1.1.1",e=e+"&request=GetCapabilities",e=e+("&urlWMS="+c);d&&(e+="&="+d);var f=this;d=new XMLHttpRequest;d.open("GET",e,!0);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onload=function(){var d=$.parseXML(this.responseText);f._createWMSDropwDown(a,b,d,c)};d.send()},_createWMSDropwDown:function(a,b,c,d){FM.Util.randomID();$(c).find("Layer").each(function(){var c=
FM.Util.randomID();if($(this).children("Name").text()){$("#"+a).append("<div id='WMSLayer-"+c+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var f={};f.layers=$(this).children("Name").text();f.layername=$(this).children("Name").text();f.layertitle=$(this).children("Title").text();f.style=$(this).children("Style").children("Name").text();f.urlWMS=d;f.openlegend=!0;f.srs=b.map.options.crs.code;$("#WMSLayer-"+c).click({fenixmap:b,layer:f},function(a){var b=
new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})},WFSCapabilities:function(a,b,c){var d="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES,d=d+"?SERVICE=WFS&VERSION=1.0.0",d=d+"&request=GetCapabilities",d=d+("&urlWMS="+c),e=new XMLHttpRequest;e.open("GET",d,!0);e.setRequestHeader("Content-type","application/x-www-form-urlencoded");e.onload=function(){var d=$.parseXML(this.responseText);FM.WMSUtils._createWMSDropwDown(a,b,d,c)};e.send()},_createWFSDropwDown:function(a,
b,c,d){$(c).find("Layer").each(function(){var c=FM.Util.randomID();if($(this).children("Name").text()){$("#"+a).append("<div id='WMSLayer-"+c+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var f={};f.layers=$(this).children("Name").text();f.layername=$(this).children("Name").text();f.layertitle=$(this).children("Title").text();f.style=$(this).children("Style").children("Name").text();f.urlWMS=d;f.openlegend=!0;f.srs=b.map.options.crs.code;$("#WMSLayer-"+
c).click({fenixmap:b,layer:f},function(a){var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})}});(function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b=["webkit","moz","o","ms","khtml"];if("undefined"!=typeof document.exitFullscreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;c<d;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=
function(){console.log("fullScreenApi.isFullScreen");switch(this.prefix){case "":return document.fullScreen;case "webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return""===this.prefix?a.requestFullscreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(a){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()});"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=
function(){return this.each(function(){var b=jQuery(this);a.supportsFullScreen&&a.requestFullScreen(b)})});window.fullScreenApi=a})();FM.DEPENDENCIES={FENIX_REPOSITORY:"fenixapps.fao.org/repository",fenixmap:{js:"http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js http://fenixapps.fao.org/repository/js/jquery/1.9.1/jquery.min.js http://fenixapps.fao.org/repository/js/jquery/1.0.9/jquery.i18n.properties-min.js http://code.jquery.com/ui/1.10.3/jquery-ui.js http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/jquery.powertip.min.js http://fenixapps.fao.org/repository/js/FENIX/utils/import-dependencies-1.0.js http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.js js/FENIXMap.js js/core/Class.js js/core/Util.js js/core/hashmap.js js/map/config/CONFIG.js js/map/config/DEPENDENCIES.js js/map/Map.js js/map/controller/MapController.js js/map/layer/Layer.js js/map/layer/TileLayer.js js/map/constants/TILELAYER.js js/map/gui/gui-controller.js js/map/gui/gui-map.js js/core/fullscreen.js js/core/UIUtils.js".split(" "),
css:["http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/css/jquery.powertip.css","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.css","css/fenix-map.css"]},geocoder:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css"]},
geosearch:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js","http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css"]},mouseposition:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css"]},
drawcontrol:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css"]},exportplugin:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.css"]},controlloading:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js"],
css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css"]}};FMDEFAULTLAYER={getLayer:function(a,b,c){switch(a.toUpperCase()){case "GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","adm0_code","the_geom",b,"faost_n",c);case "GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",b,"faost_n",c);case "GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","iso2_code","the_geom",b,"faost_n",c);case "GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","iso3_code","the_geom",b,"faost_n",c);case "GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");
case "GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",b,"adm1_name",c);case "GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",b,"adm2_name",c)}},_getGAUL:function(a,b,c,d,e,f){var g={};g.layers=a;g.styles="";g.joincolumn=b?b:null;g.joincolumnlabel=e?e:null;g.measurementunit=f?f:null;g.srs="EPSG:3857";g.geometrycolumn=c?c:"";d&&FMDEFAULTLAYER.joinDefaultPopUp(g);console.log(g);return g},_getWMSLayer:function(a,b,c,d){var e={};e.layers=a;e.styles=c?
c:"";e.srs=d?d:"EPSG:3857";e.urlWMS=b?b:FMCONFIG.DEFAULT_WMS_SERVER;return e},joinDefaultPopUp:function(a){console.log("joinDefaultPopUp: ");var b=a.measurementunit?"("+a.measurementunit+")":"",c=a.joincolumnlabel?"<b>{{"+a.joincolumnlabel+"}}</b><hr>":"";a.customgfi={content:{en:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} "+b+"</div>",fr:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} "+b+"</div>",es:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} "+b+"</div>"},showpopup:!0,output:{show:!0,
id:"gfiid"},callback:function(a,b){$("#"+b.outputid).empty();$("#"+b.outputid).append(a)}}}};FM.TILELAYER={OSM:{URL:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap",TITLE_FR:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{URL:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap grayscale",TITLE_FR:"OSM - OpenStreetMap grayscale"},MAPQUEST:{URL:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",TITLE_EN:"MapQuest"},MAPQUEST_NASA_AERIAL:{URL:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",TITLE_EN:"MapQuest Aerial"},
ESRI_WORLDSTREETMAP:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",TITLE_EN:"ESRI - World Street Map",TITLE_FR:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",TITLE_EN:"ESRI - World Terrain Base",TITLE_FR:"ESRI - World Terrain Base"},ACETATE_LABELS:{URL:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",TITLE_EN:"Acetate Labels"},
ACETATE_TERRAIN:{URL:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",TITLE_EN:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{URL:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",TITLE_EN:"Stamen"},ESRI_HISTORICAL_MERCATOR:{URL:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",TITLE_EN:"ESRI_HISTORICAL_MERCATOR"}};FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX WMS Server",label_EN:"FENIX",url:"http://fenixapps.fao.org/geoserver"},{label:"DATA FAO ORG",label_EN:"DATA FAO ORG",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"HarvestChoice 1",label_EN:"HarvestChoice 1",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_1/MapServer/WMSServer"},{label:"HarvestChoice 2",label_EN:"HarvestChoice 2",
url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_2/MapServer/WMSServer"},{label:"HarvestChoice 3",label_EN:"HarvestChoice 3",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_3/MapServer/WMSServer"},{label:"HarvestChoice 4",label_EN:"HarvestChoice 4",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_4/MapServer/WMSServer"},{label:"HarvestChoice 5",label_EN:"HarvestChoice 5",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_5/MapServer/WMSServer"},
{label:"HarvestChoice 6",label_EN:"HarvestChoice 6",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_6/MapServer/WMSServer"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"}]};FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",mapOptions:{lat:0,lng:0,zoom:1},options:{guiController:{enablegfi:!0},gui:{fullscreen:!0,fullscreenID:""},usedefaultbaselayers:!0,lang:"EN"},initialize:function(a,b,c){this.options=$.extend(!0,{},this.options,b);this.mapOptions=$.extend(!0,{},this.mapOptions,c);FM.initializeLangProperties(this.options.lang);b=FM.Util.randomID();c=b+"-container-map";var d=b+"-map";$("#"+a).append("<div class='fm-map-box fm-box' id='"+
c+"'><div>");$("#"+c).append("<div style='width:100%; height: 100%;' id='"+d+"'><div>");this.id=d;this.mapContainerID=c;this.suffix=b;this.options.gui.fullscreenID=""!=this.options.gui.fullscreenID?this.options.gui.fullscreenID:this.mapContainerID;this.map=new L.Map(this.id,this.mapOptions);this.setTilePaneID();$("#"+c).append("<div style='width:350px;' id='"+b+"-controller'><div>");this.controller=new FM.mapController(b,this,this.map,this.options.guiController);this.controller.initializeGUI();var e=
this;this.map._fenixMap=this;this.map.on("click",function(a){e.options.guiController.enablegfi&&e.getFeatureInfo(a)});$("#"+c).append("<div id='"+b+"-popup'><div>");$("#"+c).append("<div  class='fm-swipe' id='"+b+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+b+"-handle'>&nbsp</div></div>");$("#"+c).append(FM.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",b))},createMap:function(a,b,c){a&&(this.mapOptions.lat=a);b&&(this.mapOptions.lon=b);c&&(this.mapOptions.zoom=c);this.map.setView(new L.LatLng(this.mapOptions.lat,
this.mapOptions.lng),this.mapOptions.zoom);L.control.scale("bottomright").addTo(this.map);this.initializePlugins();this.initializeMapGUI();this.options.usedefaultbaselayers&&this._addDefaultBaseLayers()},_addDefaultBaseLayers:function(){this.addTileLayer(FM.TileLayer.createBaseLayer("OSM","EN"),!0);this.addTileLayer(FM.TileLayer.createBaseLayer("OSM_GRAYSCALE","EN"),!0);this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDSTREETMAP","EN"),!0);this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDTERRAINBASE",
"EN"),!0)},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var a=document.getElementById(this.id).childNodes[1].childNodes;$(a[0]).attr("id",this.tilePaneID)},addTileLayer:function(a,b){b?this.controller.addBaseLayer(a):(this.controller.layerAdded(a),this.map.addLayer(a.leafletLayer));this.controller.setZIndex(a)},addLayer:function(a){if(a.layer.layertype)switch(a.layer.layertype){case "JOIN":"SHADED"==a.layer.jointype.toLocaleUpperCase()?this.addShadedLayer(a):"POINT"==
a.layer.jointype.toLocaleUpperCase()&&this.addPointLayer(a);break;case "WMS":this.addLayerWMS(a);break;default:this.addLayerWMS(a)}else this.addLayerWMS(a)},removeLayer:function(a){this.controller.removeLayer(a)},addLayerWMS:function(a){this.controller.layerAdded(a);this.map.addLayer(a.createLayerWMS());this.controller.setZIndex(a);this._openlegend(a,!1);this.controller.showHide(a.id,!1)},addShadedLayer:function(a){a.layerAdded||this.controller.layerAdded(a);this.createShadeLayerRequest(a,a.isadded)},
createShadeLayerRequest:function(a,b){b||($("#"+a.id+"-controller-item-getlegend").css("display","inline-block"),$("#"+a.id+"-controller-item-opacity").css("display","block"));var c=this,d="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_SHADED,e=new RequestHandler;e.open("POST",d);e.setContentType("application/x-www-form-urlencoded");e.request.onload=function(){c._createShadeLayer(a,this.responseText,b)};e.send(FM.Util.parseLayerRequest(a.layer))},_createShadeLayer:function(a,b,c){"string"==
typeof b&&(b=$.parseJSON(b));a.layer.sldurl=b.sldurl;a.layer.urlWMS=b.geoserverwms;a.layer.legendHTML=b.legendHTML;a.createLayerWMSSLD();this._loadLayer(a,c)},createShadedLayerRequestCached:function(a,b){a.layer.sldurl?this._loadLayer(a,b):this.createShadeLayerRequest(a,b)},_loadLayer:function(a,b){(b=null!=b&&b?!0:!1)?a.leafletLayer.redraw():(this.map.addLayer(a.leafletLayer),this.controller.setZIndex(a),a.isadded=!0);this._openlegend(a,b);this.controller.showHide(a.id,b)},reAddLayer:function(a){this.map.addLayer(a.leafletLayer);
this.controller.setZIndex(a)},_openlegend:function(a,b){a.layer.openlegend&&FM.LayerLegend.getLegend(a,a.id+"-controller-item-getlegend",b)},addPointLayer:function(a){this.controller.layerAdded(a);this.createPointLayerRequest(a)},createPointLayerRequest:function(a){$("#"+a.id+"-controller-item-getlegend").css("display","none");$("#"+a.id+"-controller-item-getlegend-holder").slideUp("slow");$("#"+a.id+"-controller-item-opacity").css("display","none");var b=this,c="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_SHADED,
d=new RequestHandler;d.open("POST",c);d.setContentType("application/x-www-form-urlencoded");d.request.onload=function(){b._createPointLayer(a,this.responseText)};d.send(FM.Util.parseLayerRequest(a.layer));d.request.onerror=function(){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b])}},_createPointLayer:function(a,b){"string"==typeof b&&(b=$.parseJSON(b));a.layer.sldurl=b.sldurl;a.layer.urlWMS=b.geoserverwms;a.layer.legendHTML=b.legendHTML;
a.layer.pointsJSON=b.pointsJSON;this._refreshPointLayer(a)},_refreshPointLayer:function(a){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b]);"string"==typeof a.layer.pointsJSON&&(a.layer.pointsJSON=$.parseJSON(a.layer.pointsJSON));var c=this;a.layer.pointsLayers=[];for(b=0;b<a.layer.pointsJSON.length;b++){var d=new L.LatLng(a.layer.pointsJSON[b].lat,a.layer.pointsJSON[b].lon),e=a.layer.pointsJSON[b].properties;a.layer.pointsJSON[b].properties.measurementunit=
"";null!=a.layer.measurementuni&&(a.layer.pointsJSON[b].properties.measurementunit=a.layer.measurementunit);null!=a.layer.pointColor&&(e.color=a.layer.pointColor);null!=a.layer.pointFillColor&&(e.fillColor=a.layer.pointFillColor);null!=a.layer.pointFillOpacity&&(e.fillOpacity=a.layer.pointFillOpacity);d=(new L.CircleMarker(d,e)).addTo(this.map);d.setRadius(a.layer.pointsJSON[b].radius);d.bindPopup(e.title+" - "+e.value);d.on("mouseover",function(){$("#"+c.suffix+"-popup-join-point-holder").show();
$("#"+c.suffix+"-popup-join-point-text").empty();$("#"+c.suffix+"-popup-join-point-value").empty();$("#"+c.suffix+"-popup-join-point-text").append(this.options.title);$("#"+c.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+a.layer.measurementunit+"</i>")});d.on("mouseout",function(){$("#"+c.suffix+"-popup-join-point-holder").hide()});a.layer.pointsLayers.push(d)}},addGeoJSON:function(a){FMGeoJSON.createGeoJSONLayer(a)},syncOnMove:function(a){FM.MapUtils.syncMapsOnMove(this.map,
a)},getFeatureInfo:function(a,b){var c=a.target._fenixMap;(b=b?b:c.controller.selectedLayer)&&(null!=b.layer.layertype&&"JOIN"==b.layer.layertype?FM.SpatialQuery.getFeatureInfoJoin(b,a.layerPoint,a.latlng,c.map):FM.SpatialQuery.getFeatureInfoStandard(b,a.layerPoint,a.latlng,c.map))},zoomTo:function(a,b,c){FM.LayerUtils.zoomToBoundary(this.map,a,b,c)},zoomTo:function(a,b){FM.LayerUtils.zoomToBoundary(this.map,a,b,"EPSG:3827")},invalidateSize:function(){this.map.invalidateSize()},initializeMapGUI:function(){if(null!=
this.options.gui){var a=this;$.each(this.options.gui,function(b,c){var d="_add"+b.toLowerCase();try{if(FM.Plugins[d])FM.Plugins[d](a,c)}catch(e){throw Error("Plugin: "+d+" doesn't exist");}})}},initializePlugins:function(){if(null!=this.options.plugins){var a=this;$.each(this.options.plugins,function(b,c){var d="_add"+b.toLowerCase();FM.loadModuleLibs(b.toLowerCase(),function(){FM.Plugins[d](a,c)})})}},cloneMap:function(a){var b=this.exportMap();JSON.stringify(b.layers,function(a,b){return"function"===
typeof b?b+"":b});a=new FM.Map(a,b.map.options,b.map.mapOptions);a.createMap();a.createMapFromJSON(b);return a},createMapFromJSON:function(a){this.loadOverlays(a.layers.overlays)},exportMap:function(){var a={};a.map=this._getMapOptions();a.layers=this._getMapLayers();return a},exportMapToJSONFile:function(){var a=this.exportMap(),b=FM.Util.randomID(),a="data:application/octet-stream;filename=mapview-"+b+".fnx,"+encodeURIComponent(JSON.stringify(a));window.open(a,"mapview-"+b+".fnx").focus()},_getMapOptions:function(){var a=
{options:{},mapOptions:{}};a.options=$.extend(!0,{},this.options);a.mapOptions=$.extend(!0,{},this.mapOptions);this._getCurrentMapOptions(a.mapOptions);return a},_getCurrentMapOptions:function(a){a.lat=this.map.getCenter().lat;a.lng=this.map.getCenter().lng;a.zoom=this.map.getZoom()},_getMapLayers:function(){var a={};a.overlays=this.controller.exportOverlays();return a},loadOverlays:function(a){for(var b=0;b<a.length;b++){var c=new FM.layer(a[b]);this.addLayer(c)}}});
FM.map=function(a,b,c){return new FM.Map(a,b,c)};FM.LayerLegend={getLegend:function(a,b,c){$("#"+b+"-legend-layertitle").empty();$("#"+b+"-legendtitle").empty();$("#"+b+"-legendsubtitle").empty();$("#"+b+"-content").empty();a.layer.layertitle&&$("#"+b+"-legend-layertitle").append(a.layer.layertitle);a.layer.legendtitle&&$("#"+b+"-legendtitle").append(a.layer.legendtitle);a.layer.legendsubtitle&&$("#"+b+"-legendsubtitle").append(a.layer.legendsubtitle);var d="";if(a.layer.legendHTML)d=a.layer.legendHTML,$("#"+b+"-content").append(d);else{d=a.layer.urlWMS+
"?";d+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+a.layer.layers+"&Format=image/png";null!=a.layer.style&&""!=a.layer.style&&(d+="&style="+a.layer.style);a.layer.sldurl&&(d+="&sld="+a.layer.sldurl);var e=new String(d);FM.LayerLegend._loadLegend(d+"&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3",e,b)}c?$("#"+b+"-holder").is(":visible")&&($("#"+b+"-holder").hide(),$("#"+b+"-holder").slideDown(),
a.layer.openlegend=!0):$("#"+b+"-holder").is(":visible")?($("#"+b+"-holder").slideUp(),a.layer.openlegend=!1):($("#"+b+"-holder").slideDown(),a.layer.openlegend=!0);$("#"+b+"-remove").click({id:b+"-holder"},function(b){$("#"+b.data.id).slideUp();a.layer.openlegend=!1})},_loadLegend:function(a,b,c){var d=new Image;d.name=a;d.src=a;var e='<img id="'+c+'-img" src="'+d.src+'" class="decoded">';d.onload=function(){$("#"+c+"-content").append(e);$("#"+c+"-img").css("width",this.width);$("#"+c+"-img").css("height",
this.height)};d.onerror=function(){b?FM.LayerLegend._loadLegend(b,null,c):FM.LayerLegend._nolegend(c)}},_nolegend:function(a){var b='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+a+"-content").append(b)}};FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{overlay:!0,baselayer:!0},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$menuBox:"",$menuBoxContainer:"",$selectedMenuBox:"",getFeautureInfoLayer:[],initialize:function(a,b,c,d){this._map=c;this._fenixMap=b;this.suffix=a;this.id=a+"-controller";this._guiController=$.extend({},this._guiController,d);this.baseLayersMap=new HashMap;
this.layersMap=new HashMap;this.layersMapZIndexes=new HashMap},initializeGUI:function(){this._guiController&&($("#"+this.id).append(FM.replaceAll(FM.guiController.box,"REPLACE",this.suffix)),$("#"+this.id).append(FM.replaceAll(FM.guiController.boxIcons,"REPLACE",this.suffix)),this.$menuBox=$("#"+this.suffix+"-controller-box"),this.$menuBoxContainer=$("#"+this.suffix+"-controller-box-content"),this.$boxIcons=$("#"+this.suffix+"-controller-box-icons-container"),this.$boxIcons,this._guiController.overlay&&
(this.loadIcon("overlay"),this.initializeOverlayDragging()),this._guiController.baselayer&&this.loadIcon("baselayer"),this._guiController.wmsLoader&&(this.loadIcon("wmsLoader"),(new FM.WMSUtils).WMSCapabilities(this.suffix+"-controller-wmsLoader-dropdown",this.suffix+"-controller-wmsLoader-content",this._fenixMap,FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS)))},loadIcon:function(a){var b=FM.guiController,c=a+"Box",d=a+"Icon";this.$boxIcons.show();this.$boxIcons.append(FM.replaceAll(b[d],"REPLACE",this.suffix));
this.$menuBoxContainer.append(FM.replaceAll(b[c],"REPLACE",this.suffix));b=$("#"+this.suffix+"-controller-"+a+"Icon");b.attr("title",$.i18n.prop("_"+a));try{b.powerTip({placement:"ne"})}catch(e){}var f=this,b=$("#"+f.suffix+"-controller-"+a+"-box");$("#"+this.suffix+"-controller-"+a+"Icon").click({$id:b,suffix:this.suffix},function(a){a=a.data.$id;f.$menuBox.is(":visible")?f.$selectedMenuBox==a?(f.$menuBox.slideUp("slow"),a.hide(),f.$selectedMenuBox=""):(f.$selectedMenuBox.hide(),a.slideDown("slow"),
f.$selectedMenuBox=a):(f.$selectedMenuBox=a,f.$selectedMenuBox.show(),f.$menuBox.slideDown("slow",function(){}))});$("#"+this.suffix+"-controller-"+a+"-remove").click({$id:b,suffix:this.suffix},function(a){var b=a.data.$id;$("#"+a.data.suffix+"-controller-box").slideUp("slow");b.hide()})},initializeOverlayDragging:function(){var a=this;$("#"+this.suffix+"-controller-overlay-content").sortable({cursor:"move",opacity:"0.5",start:function(a,c){},stop:function(b,c){for(var d=$(c.item).parent().children(),
e=[],f=0,g=d.length-1;0<=g;g--){var k=$(d[g]).data("layer").id;$(d[g]).data("layer");var h=f+100;e.push($(d[g]).data("layer").id);a.updateZIndex(k,h);f++}}})},layerAdded:function(a){a.layerAdded=!0;a.layer.zindex||(a.layer.zindex=this.zIndex,a.leafletLayer.setZIndex=a.layer.zindex);this.zIndex+=2;if(!a.layer.hideLayerInControllerList){var b=FM.replaceAll(FM.guiController.legend,"REPLACE",a.id);$("#"+this.suffix+"-container-map").append(b);var c="#"+this.suffix+"-controller-overlay-content",b="#"+
a.id+"-controller-item",d=a.id+"-controller-item",e=FM.replaceAll(FM.guiController.overlay,"REPLACE",a.id);$(c).prepend(e);$("#"+a.id+"-controller-item-box").data("layer",a);$("#"+a.id+"-controller-item-box").index();this._layerGUIOptions(a);this.layersMap.set(a.id,a);this.layersMapZIndexes.set(a.layer.zindex,a.id);$(b).attr("title",$.i18n.prop("_dragdroplayer"));try{$(b).powerTip({placement:"e"})}catch(f){}var g=this;$(b+"-title").append(a.layer.layertitle);$(b+"-title").attr("title",a.layer.layertitle);
try{$(b+"-title").powerTip({placement:"se"})}catch(k){}c=$(b+"-remove");c.click({l:a},function(a){a.stopPropagation();confirm($.i18n.prop("_confirmremovelayer"))&&g.removeLayer(a.data.l);a.preventDefault()});c.attr("title",$.i18n.prop("_removelayer"));try{removeLayer.powerTip({placement:"n"})}catch(h){}c=$(b+"-enabledisable");c.click({id:a.id},function(a){g.showHide(a.data.id)});c.attr("title",$.i18n.prop("_enabledisablelayer"));try{c.powerTip({placement:"se"})}catch(q){}c=1;null!=a.layer.opacity&&
(c=a.layer.opacity);try{var m=$(b+"-opacity");m.slider({orientation:"horizontal",range:"min",min:0,max:1,step:0.1,value:c,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,c.value)}});m.attr("title",$.i18n.prop("_layeropacity"));try{m.powerTip({placement:"se"})}catch(n){}}catch(p){}m=$(b+"-getfeatureinfo");if(a.layer.enablegfi){m.click({id:a.id},function(a){var b=g.layersMap.get(a.data.id);g.selectedLayer.id==a.data.id?($("#"+g.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),
g.selectedLayer="",b.layer.defaultgfi=!1):($("#"+g.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+a.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"),g.selectedLayer=b,b.layer.defaultgfi=!0)});m.attr("title",$.i18n.prop("_getfeatureinfo"));try{m.powerTip({placement:"se"})}catch(r){}a.layer.defaultgfi&&(this.selectedLayer=a,$("#"+this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),
$("#"+a.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"))}else $(b+"-getfeatureinfo").css("display","none");m=$(b+"-getlegend");null!=a.layer.showlegend&&!1==a.layer.showlegend||m.click({id:a.id,idToRender:d+"-getlegend"},function(a){var b=g.layersMap.get(a.data.id);FM.LayerLegend.getLegend(b,a.data.idToRender)});m.attr("title",$.i18n.prop("_showhidelegend"));try{m.powerTip({placement:"se"})}catch(t){}m.css("display","inline-block");if(a.layer.layertype&&"JOIN"==a.layer.layertype&&
(null==a.layer.switchjointype||a.layer.switchjointype)){$(b+"-switchjointype").css("display","inline-block");$(b+"-switchjointype").click({id:a.id},function(a){g.switchJoinType(a.data.id)});"point"==a.layer.jointype.toLowerCase()?$(b+"-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")):"shaded"==a.layer.jointype.toLowerCase()&&$(b+"-switchjointype").attr("title",$.i18n.prop("_switchtopoint"));try{$(b+"-switchjointype").powerTip({placement:"se"})}catch(v){}}var u=$(b+"-swipe");u.click({id:a.id},
function(a){a=g.layersMap.get(a.data.id);null!=a.layer.swipeActive&&a.layer.swipeActive?(FM.LayerSwipe.swipeDeactivate(a,g._map),u.removeClass("fm-icon-swipe-selected")):(FM.LayerSwipe.swipeActivate(a,g._fenixMap.suffix+"-handle",g._fenixMap.suffix+"-map",g._map),u.addClass("fm-icon-swipe-selected"))});d=$(b+"-zoomtolayer");a.layer.zoomToBBOX&&(d.css("display","inline-block"),d.attr("title",$.i18n.prop("_zoomtolayer")),d.click({id:a.id},function(a){a=g.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(g._map,
a.layer)}));a.layer.zoomTo&&(d.css("display","inline-block"),d.attr("title",$.i18n.prop("_zoomtolayer")),d.click({id:a.id},function(a){a=g.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(g._map,a.layer)}));var s=$(b+"-showhide-subicons"),w=$(b+"-subicons");s.click(function(a){w.slideToggle();s.hasClass("fm-icon-up")?(s.removeClass("fm-icon-up"),s.addClass("fm-icon-down")):(s.removeClass("fm-icon-down"),s.addClass("fm-icon-up"))});s.attr("title",$.i18n.prop("_layersubicons"));try{s.powerTip({placement:"n"})}catch(x){}}},
_layerGUIOptions:function(a){"JOIN"==a.layer.layertype&&null!=a.layer.gui&&null!=a.layer.gui.nojoinlayerswitch&&a.layer.gui.nojoinlayerswitch&&$("#"+a.id+"-controller-item-switchjointype").css("display","none")},addBaseLayer:function(a){a.layer.zindex=this.zIndexBaseLayer;this.zIndexBaseLayer+=2;this.baseLayersMap.set(a.id,a);this.layersMapZIndexes.set(a.layer.zindex,a.id);var b="#"+this.suffix+"-controller-baselayer-content",c="#"+a.id+"-controller-item",d=FM.replaceAll(FM.guiController.baselayer,
"REPLACE",a.id),d=FM.replaceAll(d,"MAPID",this._fenixMap.id);$(b).append(d);var e=this;$(c+"-title").append(a.layer.layertitle);$("#"+a.id+"-controller-item-baselayer-image").attr("src",FMCONFIG.BASEURL+"/css/images/baselayers/"+a.layer.layername+".png");$(c+"-enabledisable").click({id:a.id},function(a){e.showHide(a.data.id)});b=1;null!=a.layer.opacity&&(b=a.layer.opacity);try{$(c+"-opacity").slider({orientation:"horizontal",range:"min",min:0,max:1,step:0.1,value:b,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,
c.value)}})}catch(f){}$("#"+a.id+"-controller-box-item").click({id:a.id},function(a){a=e.baseLayersMap.get(a.data.id);e.removeBaseLayerByID(e.currentBaseLayer.id);var b=e.baseLayersMap.get(e.currentBaseLayer.id);$("#"+b.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected");$("#"+b.id+"-controller-item-opacity").hide();$("#"+a.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected");$("#"+a.id+"-controller-item-opacity").show();
e._map.addLayer(a.leafletLayer);e.currentBaseLayer=a;e.setZIndex(a)});1==this.baseLayersMap.count()&&($(c+"-radio").attr("checked",!0),this._map.addLayer(a.leafletLayer),this.currentBaseLayer=a,$("#"+a.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+a.id+"-controller-item-opacity").show(),e.setZIndex(a))},removeLayer:function(a){null!=a.layer.jointype&&"point"==a.layer.jointype?this.removeLayerPoint(a):this.removeLayerDefault(a)},removeLayerDefault:function(a){this._map.removeLayer(a.leafletLayer);
this.layersMap.remove(a.id);this.layersMapZIndexes.remove(a.layer.zindex);$("#"+a.id+"-controller-item-box").remove();$("#"+a.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(a){for(var b=0;b<a.layer.pointsLayers.length;b++)this._map.removeLayer(a.layer.pointsLayers[b]);this.layersMap.remove(a.id);this.layersMapZIndexes.remove(a.layer.zindex);$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(a){a=this.baseLayersMap.get(a);this._map.removeLayer(a.leafletLayer)},
switchJoinType:function(a){var b=this.layersMap.get(a);try{$.powerTip.destroy($("#"+b.id+"-controller-item-switchjointype"))}catch(c){}"point"==b.layer.jointype.toLowerCase()?($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtopoint")),this.switchToShaded(a)):"shaded"==b.layer.jointype.toLowerCase()&&($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")),this.switchToPoint(a));try{$("#"+b.id+"-controller-item-switchjointype").powerTip({placement:"se"})}catch(d){}},
switchToPointswitchToPoint:function(a){a=this.layersMap.get(a);a.layer.jointype="point";null!=a.leafletLayer&&this._map.removeLayer(a.leafletLayer);this._fenixMap.createPointLayerRequest(a)},switchToShaded:function(a){a=this.layersMap.get(a);a.layer.jointype="shaded";if(null!=a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this._map.removeLayer(a.layer.pointsLayers[b]);this._fenixMap.createShadeLayerRequest(a)},showHide:function(a,b){var c=this.layersMap.get(a);c.layer.jointype&&
"point"==c.layer.jointype.toLowerCase()?this.showHidePointLayer(a):this.showHideLayer(a,b)},showHidePointLayer:function(a){for(var b=this.layersMap.get(a),c=0;c<b.layer.pointsLayers.length;c++)if(null==b.layer.visibility||b.layer.visibility)for(b.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),c=0;c<b.layer.pointsLayers.length;c++)this._map.removeLayer(b.layer.pointsLayers[c]);else for(b.layer.visibility=
!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable"),c=0;c<b.layer.pointsLayers.length;c++)this._map.addLayer(b.layer.pointsLayers[c])},showHideLayer:function(a,b){var c=this.layersMap.get(a);null==b||b?null!=b&&b||(null==c.layer.visibility||c.layer.visibility?(c.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),
this._map.removeLayer(c.leafletLayer)):(c.layer.visibility=!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable"),this._map.addLayer(c.leafletLayer),this.setZIndex(c))):!1==c.layer.visibility&&($("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(c.leafletLayer))},updateZIndex:function(a,b){var c=this.layersMap.get(a);
c.layer.zindex=b;c.leafletLayer.setZindex=b;try{document.getElementById(c.id).style.zIndex=b}catch(d){console.log("error updateZIndex: "+c.id+" doesnt exists")}},setZIndex:function(a){var b=document.getElementById(this._fenixMap.tilePaneID).childNodes;i=0;for(len=b.length;i<len;i++)if(b[i]!==this._container){var c=parseInt(b[i].style.zIndex,10);isNaN(c)&&(b[i].style.zIndex=a.layer.zindex,b[i].id=a.id)}},selectGetFeatureInfoIcon:function(a){for(var b=0;b<this.layersMap.count();b++)this.layersMap._data[b]==
a?$("#"+a+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"):$("#"+a+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")},exportOverlays:function(){console.log("exportOverlays");var a=[];this.layersMap.forEach(function(b){a.push(b.layer.zindex)});a=a.sort();console.log(a);for(var b=[],c=0;c<a.length;c++)this.layersMap.forEach(function(d){d.layer.zindex==a[c]&&b.push(d.layer)});return $.map(b,function(a){return $.extend(!0,{},a)})},exportBaselayers:function(){return null},
updateZindexCounter:function(){}});FM.mapController=function(a,b,c,d){return new FM.MAPController(a,b,c,d)};FM.LayerLegend={getLegend:function(a,b,c){$("#"+b+"-legend-layertitle").empty();$("#"+b+"-legendtitle").empty();$("#"+b+"-legendsubtitle").empty();$("#"+b+"-content").empty();a.layer.layertitle&&$("#"+b+"-legend-layertitle").append(a.layer.layertitle);a.layer.legendtitle&&$("#"+b+"-legendtitle").append(a.layer.legendtitle);a.layer.legendsubtitle&&$("#"+b+"-legendsubtitle").append(a.layer.legendsubtitle);var d="";if(a.layer.legendHTML)d=a.layer.legendHTML,$("#"+b+"-content").append(d);else{d=a.layer.urlWMS+
"?";d+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+a.layer.layers+"&Format=image/png";null!=a.layer.style&&""!=a.layer.style&&(d+="&style="+a.layer.style);a.layer.sldurl&&(d+="&sld="+a.layer.sldurl);var e=new String(d);FM.LayerLegend._loadLegend(d+"&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3",e,b)}c?$("#"+b+"-holder").is(":visible")&&($("#"+b+"-holder").hide(),$("#"+b+"-holder").slideDown(),
a.layer.openlegend=!0):$("#"+b+"-holder").is(":visible")?($("#"+b+"-holder").slideUp(),a.layer.openlegend=!1):($("#"+b+"-holder").slideDown(),a.layer.openlegend=!0);$("#"+b+"-remove").click({id:b+"-holder"},function(b){$("#"+b.data.id).slideUp();a.layer.openlegend=!1})},_loadLegend:function(a,b,c){var d=new Image;d.name=a;d.src=a;var e='<img id="'+c+'-img" src="'+d.src+'" class="decoded">';d.onload=function(){$("#"+c+"-content").append(e);$("#"+c+"-img").css("width",this.width);$("#"+c+"-img").css("height",
this.height)};d.onerror=function(){b?FM.LayerLegend._loadLegend(b,null,c):FM.LayerLegend._nolegend(c)}},_nolegend:function(a){var b='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+a+"-content").append(b)}};FM.LayerSwipe={swipeActivate:function(a,b,c,d){function e(a){a=Math.max(0,Math.min(a,d.getSize().x));g.style.left=a+"px";a=d.containerPointToLayerPoint(a,0).x;f.style.clip="rect(-99999px "+a+"px 999999px -99999px)"}a.layer.swipeActive=!0;var f=a.leafletLayer._container,g=document.getElementById(b),k=!1;g.onmousedown=function(){k=!0;return!1};document.onmouseup=function(){k=!1};document.onmousemove=function(a){k&&e(a.x)};a.redraw=function(b){f=a.leafletLayer._container;e(parseInt(g.style.left))};a.mousemoveSwipe=
function(b){f=a.leafletLayer._container;e(b.containerPoint.x)};d.on("zoomend",a.redraw);d.on("moveend",a.redraw);d.on("drag",a.redraw);d.on("mousemove",a.mousemoveSwipe);b=$("#"+c).width();e(b/2)},swipeDeactivate:function(a,b){b.off("zoomend",a.redraw);b.off("moveend",a.redraw);b.off("drag",a.redraw);b.off("mousemove",a.mousemoveSwipe);a.layer.swipeActive=!1;a.leafletLayer._container.style.clip="auto"}};FM.LayerUtils={zoomToLayer:function(a,b){b.bbox?FM.LayerUtils.zoomTOBBOX(a,b.bbox):b.zoomTo&&FM.LayerUtils.zoomToBoundary(a,b.zoomTo.boundary,b.zoomTo.code,b.zoomTo.srs)},zoomToBoundary:function(a,b,c,d){FM.LayerUtils._zoomToRequest(a,b,c,d)},zoomTOBBOX:function(a,b){var c;if(b.ymin){c=new L.LatLng(b.ymin,b.xmin);var d=new L.LatLng(b.ymax,b.xmax);c=new L.LatLngBounds(c,d)}else b&&0<b.length&&(c=new L.LatLng(b[0],b[1]),d=new L.LatLng(b[2],b[3]),c=new L.LatLngBounds(c,d));c&&FM.LayerUtils.zoomToBounds(a,
c)},zoomToBounds:function(a,b){a.fitBounds(b)},_zoomToRequest:function(a,b,c,d){b="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_ZOOM_TO_BOUNDARY+"/"+b+"/"+c+"/"+d+"";c=new RequestHandler;c.open("GET",b);c.setContentType("application/x-www-form-urlencoded");c.request.onload=function(){var b=this.responseText;"string"==typeof b&&(b=$.parseJSON(b));var c=new L.LatLng(b.ymin,b.xmin),b=new L.LatLng(b.ymax,b.xmax),c=new L.LatLngBounds(c,b);a.fitBounds(c)};c.send(null)},setLayerOpacity:function(a,
b){a.leafletLayer&&a.leafletLayer.setOpacity(b);a.layer.opacity=b;a.leafletLayer.options.opacity=b;console.log(a.leafletLayer)},filterLayerMinEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesMinEqualThan(b,c);FM.LayerUtils._refreshLayer(a,b)},filterLayerGreaterEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesGreaterEqualThan(b,c);FM.LayerUtils._refreshLayer(a,b)},filterLayerInBetweenEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesInBetweenEqualThan(b,c,d);FM.LayerUtils._refreshLayer(a,b)},
filterLayerOuterEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesOuterEqualThan(b,c,d);FM.LayerUtils._refreshLayer(a,b)},_refreshLayer:function(a,b){switch(b.layer.jointype){case "point":a.createPointLayerRequest(b);break;case "shaded":a.createShadeLayerRequest(b,!0)}},getValuesMinEqualThan:function(a,b){"string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata));a.layer.joindata=[];for(i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,
d){d<=b&&a.layer.joindata.push(a.layer.defaultdata[i])});a.layer.joindata=JSON.stringify(a.layer.joindata);return a},getValuesGreaterEqualThan:function(a,b){"string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata));a.layer.joindata=[];for(i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,d){d>=b&&a.layer.joindata.push(a.layer.defaultdata[i])});a.layer.joindata=JSON.stringify(a.layer.joindata);return a},getValuesInBetweenEqualThan:function(a,
b,c){"string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata));a.layer.joindata=[];for(i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(d,e){e>=b&&e<=c&&a.layer.joindata.push(a.layer.defaultdata[i])});a.layer.joindata=JSON.stringify(a.layer.joindata);return a},getValuesOuterEqualThan:function(a,b,c){"string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata));a.layer.joindata=[];for(i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],
function(d,e){(b&&e<=b||c&&e>=c)&&a.layer.joindata.push(a.layer.defaultdata[i])});a.layer.joindata=JSON.stringify(a.layer.joindata);return a}};FM.MapUtils=function(){return{syncMapsOnMove:function(a,b){var c=a.map?a.map:a,d=b.map?b.map:b;c.on("dragend zoomend",function(a){c.getCenter()!=d.getCenter&&c.getZoom()!=d.getZoom&&d.setView(c.getCenter(),c.getZoom())})},exportLayers:function(a){}}}();FM.Plugins={_addfullscreen:function(a,b){b&&(console.log(a.options.gui.fullscreenID),$("#"+a.mapContainerID).append("<div class='fm-icon-box-background fm-btn-icon fm-fullscreen'><div class='fm-icon-sprite fm-icon-fullscreen' id='"+a.suffix+"-fullscreenBtn'><div></div>"),FM.UIUtils.fullscreen(a.suffix+"-fullscreenBtn",a.options.gui.fullscreenID))},_addlayercontroller:function(a,b){b?$("#"+this.suffix+"-controller").show():$("#"+this.suffix+"-controller").hide()},_addgeosearch:function(a,b){b&&(new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap})).addTo(a.map)},
_addgeocoder:function(a,b){if(b){var c=new L.Control.OSMGeocoder;a.map.addControl(c)}},_addmouseposition:function(a,b){b&&L.control.mousePosition().addTo(a.map)},_addexport:function(a,b){b&&a.map.addControl(new L.Control.Export)},_addzoomcontrol:function(a,b){var c=new L.Control.Zoom;c.setPosition("bottomright");a.map.addControl(c)},_addprintmodule:function(a,b){if(b)var c=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:!0,dpi:254});c=L.control.print({provider:c});
a.map.addControl(c)},_adddisclaimerfao:function(a,b){if(b){var c=FM.replaceAll(FM.guiMap.disclaimerfao,"REPLACE",a.suffix);$("#"+a.suffix+"-container-map").append(c);c="";switch(a.options.lang.toUpperCase()){case "ES":c=FM.guiMap.disclaimerfao_S;break;case "FR":c=FM.guiMap.disclaimerfao_F;break;default:c=FM.guiMap.disclaimerfao_E}c=FM.replaceAll(c,"REPLACE",a.suffix);$("#"+a.suffix+"-disclaimerfao").attr("title",c);try{$("#"+a.suffix+"-disclaimerfao").powerTip({placement:"nw"})}catch(d){}}},_adddrawcontrol:function(a,
b){if(b){var c=new L.FeatureGroup;a.map.addLayer(c);var d=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:!1,drawError:{color:"#b00b00",timeout:1E3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:c}});a.map.addControl(d);a.map.on("draw:created",function(b){var d=b.layerType;b=b.layer;"marker"===d&&b.bindPopup("A popup!");l=b;l.layerType=d;c.addLayer(b);a.spatialQuery(b)});a.map.on("draw:edited",function(a){var b=
0;a.layers.eachLayer(function(a){b++})})}},_addcontrolloading:function(a,b){if(b){var c=L.Control.loading({separate:!0,position:"topright"});a.map.addControl(c)}}};FM.SpatialQuery={getFeatureInfoJoin:function(a,b,c,d){null==a.layer.custompopup&&FMDEFAULTLAYER.joinDefaultPopUp(a.layer);FM.SpatialQuery.getFeatureInfoStandard(a,b,c,d)},getFeatureInfoStandard:function(a,b,c,d){var e=d.getBounds(),f=d.options.crs.project(e.getSouthWest()),e=d.options.crs.project(e.getNorthEast()),f=f.x+","+f.y+","+e.x+","+e.y,e=d.getSize().x,g=d.getSize().y,k=d.layerPointToContainerPoint(b).x;b=d.layerPointToContainerPoint(b).y;k=new Number(k);k=k.toFixed(0);b=new Number(b);b=b.toFixed(0);
var h="http://"+FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_GFI_STANDARD,h=h+"?SERVICE=WMS&VERSION=1.1.1",h=h+"&REQUEST=GetFeatureInfo",h=h+("&BBOX="+f),h=h+("&HEIGHT="+g),h=h+("&WIDTH="+e),h=h+("&X="+k),h=h+("&Y="+b),h=h+"&FORMAT=image/png",h=h+"&INFO_FORMAT=text/html";""!=a&&null!=a&&(h+="&LAYERS="+a.layer.layers,h+="&QUERY_LAYERS="+a.layer.layers,h+="&STYLES=",h+="&SRS="+a.layer.srs,h+="&urlWMS="+a.layer.urlWMS,FM.SpatialQuery.getFeatureInfoJoinRequest(h,"GET",c,d,a))},getFeatureInfoJoinRequest:function(a,
b,c,d,e){e.layer.lang&&e.layer.lang.toLocaleLowerCase();var f=new RequestHandler;f.open(b,a);f.setContentType("application/x-www-form-urlencoded");f.onload(function(){var a=this.responseText;if(null!=a){var b=$("#"+d._fenixMap.id).width()-15,f=$("#"+d._fenixMap.id).height()-15,b=new L.Popup({maxWidth:b,maxHeight:f}),f=a,f=e.layer.customgfi?FM.SpatialQuery.customPopup(a,e.layer.customgfi,e.layer.lang,e.layer.joindata):FM.SpatialQuery.transposeHTMLTable(a),f=null!=f?f[0]:a,f=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(f);
e.layer.customgfi?(e.layer.customgfi&&e.layer.customgfi.callback&&e.layer.customgfi.callback(f,e.layer),e.layer.customgfi&&e.layer.customgfi.output&&e.layer.customgfi.output.show&&($("#"+e.layer.customgfi.output.id).empty(),f&&$("#"+e.layer.customgfi.output.id).append(f)),e.layer.customgfi&&e.layer.customgfi.showpopup&&f&&(b.setLatLng(c).setContent(f),d.openPopup(b))):f&&(b.setLatLng(c).setContent(f),d.openPopup(b))}});f.send()},customPopup:function(a,b,c,d){var e=this._parseHTML(b.content[c]);if(0<
e.id.length||0<e.joinid.length)if(a=$("<div></div>").append(a).find("table"))return FM.SpatialQuery._customizePopUp(b.content[c],e,a,d)},_checkGeoserverDefaultEmptyOutput:function(a){return a},_customizePopUp:function(a,b,c,d){var e=c.find("tr");c=$(e[0]).find("th");for(var f=[],g=[],k=0;k<c.length;k++)for(var h=0;h<b.id.length;h++)if(b.id[h].toUpperCase()==c[k].innerHTML.toUpperCase()){g.push(k);break}if(d){var q=[];console.log("values.joinid");console.log(b.joinid);for(k=0;k<c.length;k++)for(h=
0;h<b.joinid.length;h++)if(b.joinid[h].toUpperCase()==c[k].innerHTML.toUpperCase()){q.push(k);break}}for(k=1;k<e.length;k++)f.push($(e[k]).find("td"));console.log(f);console.log(c);b=[];console.log(f);for(h=0;h<f.length;h++){e=a;for(k=0;k<g.length;k++){var m="{{"+c[g[k]].innerHTML+"}}",n=f[h][g[k]].innerHTML;console.log(n);e=FM.Util.replaceAll(e,m,n)}if(d)for(console.log("here"),console.log(q),k=0;k<q.length;k++)m="{{{"+c[q[k]].innerHTML+"}}}",n=f[h][q[k]].innerHTML,n=FM.SpatialQuery._getJoinValueFromCode(n,
d),e=FM.Util.replaceAll(e,m,n);b.push(e)}return b},_getJoinValueFromCode:function(a,b){for(var c=parseInt(a)?parseInt(a):null,d=$.parseJSON(b),e=0;e<d.length;e++)if(d[e][a]||d[e][c])if(d[e][a])d[e][a];else return d[e][c];return""},_parseHTML:function(a){var b={id:[],joinid:[]};console.log(a);a=a.match(/\{\{.*?\}\}/g);for(var c=0;c<a.length;c++)a[c]=FM.Util.replaceAll(a[c],"{{",""),a[c]=FM.Util.replaceAll(a[c],"}}",""),0<=a[c].indexOf("{")?(a[c]=FM.Util.replaceAll(a[c],"{",""),a[c]=FM.Util.replaceAll(a[c],
"}",""),b.joinid.push(a[c])):b.id.push(a[c]);return b},transposeHTMLTable:function(a){if(a=$("<div></div>").append(a).find("table"))if(a=FM.SpatialQuery.transposeHTML(a),console.log(a),null!=a)return a;return null},transposeHTML:function(a){var b=$('<div class="fm-transpose-popup"></div>'),c=a.find("caption");console.log(a);try{b.append(c[0].innerHTML);var d=a.find("tr"),e=$(d[0]).find("th");a=[];for(c=1;c<d.length;c++)a.push($(d[c]).find("td"));for(var f=$("<table></table>"),g=$("<tbody></tbody>"),
c=0;c<e.length;c++){for(var d="<tr>",k="<td>"+e[c].innerHTML+"</td>",h=0;h<a.length;h++)k+="<td>"+a[h][c].innerHTML+"</td>";d+=k;d+="</tr>";g.append(d)}return b.append(f.append(g))}catch(q){return null}},scatterLayerFilter:function(a,b,c,d,e,f,g,k,h,q){if(!a.leafletLayer||q)a.layer.joindata=[];for(var m="",n=0;n<c.length;n++)if(c[n].data[0][0]>=d&&c[n].data[0][0]<=e&&c[n].data[0][1]>=f&&c[n].data[0][1]<=g){var p=c[n].geocode;""!=m&&(m+=",");p&&(m+="'"+p+"'");p={};p[c[n].geocode]=c[n].data[0][0]/c[n].data[0][1];
a.leafletLayer&&!q||a.layer.joindata.push(p)}if(!a.leafletLayer||q)a.layer.joindata=JSON.stringify(a.layer.joindata);a.leafletLayer?(h&&FM.SpatialQuery.highlightFeaturesOfLayer(h,m),q&&b.createShadeLayerRequest(a,!0),k&&FM.SpatialQuery._sampleSpatialQueryBoundingBox(b.map,m,a.layer)):b.addShadedLayer(a)},scatterLayerFilterFaster:function(a,b,c,d,e,f,g,k,h,q){var m=a.layer.zoomToFeatures?a.layer.zoomToFeatures:!1;if(!a.leafletLayer||h)a.layer.joindata=[];for(var n="",p=0;p<c.length;p++)for(var r=0;r<
c[p].data.length;r++)if(c[p].data[r].x>=d&&c[p].data[r].x<=e&&c[p].data[r].y>=f&&c[p].data[r].y<=g){var t=c[p].data[r].code;""!=n&&(n+=",");t&&(n+="'"+t+"'");t={};if(0!=c[p].data[r].x&&0!=c[p].data[r].y){var v=q?eval(q):c[p].data[r].x/c[p].data[r].y;t[c[p].data[r].code]=v;a.leafletLayer&&!h||a.layer.joindata.push(t)}}if(!a.leafletLayer||h)a.layer.joindata=JSON.stringify(a.layer.joindata);a.leafletLayer?(k&&FM.SpatialQuery.highlightFeaturesOfLayer(k,n),h&&b.createShadeLayerRequest(a,!0),m&&FM.SpatialQuery._sampleSpatialQueryBoundingBox(b.map,
n,a.layer)):b.addShadedLayer(a)},highlightFeaturesOfLayer:function(a,b){console.log(b);b=FM.Util.replaceAll(b,"'","");a.layer.cql_filter=a.layer.joincolumn+" IN ("+b+")";a.layerAdded?a.redraw():a.addLayerWMS()},_sampleSpatialQueryBoundingBox:function(a,b,c){var d={datasource:"FENIX"};d.select="ST_AsText(ST_Transform(ST_Envelope(ST_Collect("+c.geometrycolumn+")), 4326)) ";d.from=c.layername?c.layername:c.layers;d.where=c.joincolumn+" IN ("+b+") ";$.ajax({type:"POST",url:FMCONFIG.BASEURL_WDS+FMCONFIG.WDS_SERVICE_SPATIAL_QUERY,
data:d,success:function(b){var c=new Wkt.Wkt;c.read(b);FM.LayerUtils.zoomTOBBOX(a,{xmin:c.components[0][0].x,xmax:c.components[0][2].x,ymax:c.components[0][1].y,ymin:c.components[0][0].y})},error:function(a,b,c){}})},_sampleSpatialQueryCentroid:function(a,b){var c={datasource:"FENIX",select:"ST_AsText(ST_Transform(ST_Centroid(ST_Collect(geom)), 4326)) ",from:"gaul0_faostat_3857"};c.where="faost_code IN ("+b+") ";$.ajax({type:"POST",url:FMCONFIG.BASEURL_WDS+FMCONFIG.WDS_SERVICE_SPATIAL_QUERY,data:c,
success:function(b){var c=new Wkt.Wkt;c.read(b);console.log(c);a.panTo([c.components[0].y,c.components[0].x])},error:function(a,b,c){}})},filterLayerMinEqualThan:function(a,b){FM.LayerUtils.filterLayerMinEqualThan(this,a,b)},filterLayerGreaterEqualThan:function(a,b){FM.LayerUtils.filterLayerGreaterEqualThan(this,a,b)},filterLayerInBetweenEqualThan:function(a,b,c){FM.LayerUtils.filterLayerInBetweenEqualThan(this,a,b,c)},filterLayerOuterEqualThan:function(a,b,c){FM.LayerUtils.filterLayerOuterEqualThan(this,
a,b,c)}};FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:!0,format:"image/png",transparent:"TRUE",opacity:1,layertitle:"",enablegfi:!0,layertype:"WMS",openlegend:!1,switchjointype:!1,lang:"en"},leafletLayer:"",initialize:function(a,b){this.layer=$.extend(!0,{},this.layer,a);this.id=FM.Util.randomID();a.joindata&&(a.defaultdata=a.joindata);b&&(this._fenixmap=b)},createLayerWMS:function(){var a=this._getWMSParameters();this.leafletLayer?this.leafletLayer.setParams(a):
this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a);return this.leafletLayer},createLayerWMSSLD:function(){var a=this._getWMSParameters();this.leafletLayer?this.leafletLayer.setParams(a):this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a);return this.leafletLayer},_getWMSParameters:function(){var a={};a.id=this.id;a.layers=this.layer.layers;this.layer.layername&&(a.layers=this.layer.layername);a.format=this.layer.format;a.transparent=this.layer.transparent.toUpperCase();a.visibility=
this.layer.visibility;a.opacity=this.layer.opacity;a.styles=this.layer.styles;this.layer.style&&(a.styles=this.layer.style);this.layer.sldurl&&(a.sld=this.layer.sldurl);this.layer.cql_filter&&(a.cql_filter=this.layer.cql_filter);this.layer.sld_body&&(a.sld_body=this.layer.sld_body);return a},redraw:function(){if(l.layer.layertype)switch(l.layer.layertype){case "JOIN":"SHADED"==l.layer.jointype.toLocaleUpperCase()?fenixmap?fenixmap.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this):"POINT"==
l.layer.jointype.toLocaleUpperCase()&&console.log("TODO: handle redraw point");break;case "WMS":this.createLayerWMS();this.leafletLayer.redraw();break;default:this.createLayerWMS(),this.leafletLayer.redraw()}},removeLayer:function(a){a?a.removeLayer(this):this._fenixmap&&this._fenixmap.removeLayer(this)},addPointLayer:function(a){a?a.addPointLayer(this):this._fenixmap&&this._fenixmap.addPointLayer(this)},addLayerWMS:function(a){a?a.addLayerWMS(this):this._fenixmap&&this._fenixmap.addLayerWMS(this)},
addLayer:function(a){a?a.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this)},addShadedLayer:function(a){a?a.addShadedLayer(this):this._fenixmap&&this._fenixmap.addShadedLayer(this)},createShadedLayerRequestCached:function(a){a?(a.controller.layerAdded(this),a.createShadedLayerRequestCached(this)):this._fenixmap&&(this._fenixmap.controller.layerAdded(this),this._fenixmap.createShadedLayerRequestCached(this))},createShadeLayerRequestCached:function(a,b){this._fenixmap&&(a=this._fenixmap);
var c=this,d=new RequestHandler;d.open("POST","http://"+FM.CONFIG.BASEURL_MAPS+FM.CONFIG.MAP_SERVICE_SHADED);d.setContentType("application/x-www-form-urlencoded");d.onload(function(){var d=this.responseText;"string"==typeof d&&(d=$.parseJSON(d));c.layer.sldurl=d.sldurl;c.layer.urlWMS=d.geoserverwms;c.layer.legendHTML=d.legendHTML;c.createLayerWMSSLD();b&&(a.controller.layerAdded(c),a._loadLayer(c,!1))});d.send(FM.Util.parseLayerRequest(c.layer))}});FM.layer=function(a,b){return new FM.Layer(a,b)};FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var a="TITLE_"+this.layer.lang.toUpperCase(),b=FM.TILELAYER[this.layer.layername];this.layer.layertitle={};this.layer.layertitle=b[a];this.layer.layertype="TILE";return new L.TileLayer(b.URL)}});FM.TileLayer.createBaseLayer=function(a,b){var c={};c.layername=a;c.layertype="TILE";c.lang=b;var d=new FM.TileLayer(c);d.leafletLayer=d.createTileLayer(c.layername);return d};FM.guiController={boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',box:'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" style="display:none" id="REPLACE-controller-box"><div id="REPLACE-controller-box-content"></div></div>',baselayerIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-baselayers' id='REPLACE-controller-baselayerIcon'><div></div>",baselayerBox:'<div class="fm-box-zindex" id="REPLACE-controller-baselayer-box" style="display:none"><div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div><div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div></div>',
baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fm-controller-box-item-baselayer-content"><div id="REPLACE-controller-item"><div class="fm-controller-box-item-baselayer-image"><img style="width:48px; height:48px" id="REPLACE-controller-item-baselayer-image" src=""></div><div class="fm-controller-box-item-baselayer-text"><div><label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label></div><div style="clear:both"></div><div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div></div></div></div>',
overlayIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex" id="REPLACE-controller-overlay-box" style="display:none;"><div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div><div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div></div>',
overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fm-controller-box-item"><div id="REPLACE-controller-item" class="fm-controller-box-header"><div class="fm-controller-box-header-text"><div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-remove" id="REPLACE-controller-item-remove"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-info" id="REPLACE-controller-item-icon" ></div></div><div style="clear:both"></div><div class="fm-controller-box-icons"><div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div><div  class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div></div><div style="clear:both"></div><div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;"><div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div><div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div></div></div></div></div></div>',
wmsLoaderIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex" id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;"><div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div><div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div class="clear:both"></div><div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div><div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div></div>',
wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box"><div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div><div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div></div>',legend:'<div class="fm-box-zindex fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder"><div class="fm-legend-title-content"><div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div><div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div><div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div><div id="REPLACE-controller-item-getlegend-content" ></div></div>',
popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none"><div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div><div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div></div>'};FM.guiMap={disclaimerfao:'<div class="fm-icon-box-background fm-disclaimerfao fm-btn-icon"><div class="fm-icon-sprite fm-icon-info" id="REPLACE-disclaimerfao"></div></div>',disclaimerfao_E:'<div class="fm-disclaimerfao-text">The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of <br>FAO concerning the legal or constitutional status of any country,<br>territory or sea area, or concerning the delimitation of frontiers.<br>South Sudan declared its independence on July 9, 2011.<br>Due to data availability, the assessment presented in the map for Sudan<br>and South Sudan reflects thesituation up to 2011 for the former Sudan.</div> ',
disclaimerfao_E:"The designations employed and the presentation of material in the maps do not imply the expression of any opinion whatsoever on the part of FAO concerning the legal or constitutional status of any country, territory or sea area, or concerning the delimitation of frontiers. South Sudan declared its independence on July 9, 2011. Due to data availability, the assessment presented in the map for Sudan and South Sudan reflects thesituation up to 2011 for the former Sudan.",disclaimerfao_S:"",
disclaimerfao_S_styled:'<div class="fm-disclaimerfao-text"></div> ',disclaimerfao_F:"",disclaimerfao_F_styled:'<div class="fm-disclaimerfao-text"></div> '};var FMPopUp=function(){function a(){var a=b.id?b.id:(Math.random().toString(36).substring(7)+Date.now()).toLocaleLowerCase(),d='<div id="'+a+'" style="'+b.style+'">'+b.content+" </div>";$("#"+b.parentID).append(d);$("#"+a).slideDown("slow");window.setTimeout(function(){$("#"+a).slideUp("slow",function(){$("#"+a).remove()})},b.timeout)}var b={id:null,parentID:null,content:null,style:"display:none; z-index:5000; position:absolute; bottom:10px; right:10px; padding:15px; background-color:#000000; color:#FFFFFF;",
timeout:2500};return{init:function(c){b=$.extend(!0,{},b,c);a()}}}();